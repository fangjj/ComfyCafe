---
- name: ensure imagemagick is at the latest version
  apt: pkg=imagemagick state=latest
- name: ensure ffmpeg is at the latest version
  apt: pkg=ffmpeg state=latest

- name: Add group "teruimages"
  group: name=teruimages
- name: Add user "teruimages"
  user: name=teruimages group=teruimages home=/srv/TeruImages/
- name: copy TeruImages systemd unit file
  template: src=TeruImages.service.j2 dest=/etc/systemd/system/TeruImages.service
  notify:
  - start TeruImages

- name: ensure git is at the latest version
  apt: pkg=git state=latest
  when: useGit
- name: pull from TeruImages repo
  git: repo={{ repository }} dest=/srv/TeruImages/src
  when: useGit
- name: build Meteor bundle
  command: /usr/local/bin/meteor build --directory /srv/TeruImages
  args:
    chdir: /srv/TeruImages/src
  register: bundle
  when: useGit

- name: copy Meteor bundle
  copy: src=../TeruImages.tar.gz dest=/srv/TeruImages/TeruImages.tar.gz
  register: bundle
  when: not useGit

- name: unpack Meteor bundle
  unarchive: src=/srv/TeruImages/TeruImages.tar.gz dest=/srv/TeruImages copy=false
  when: bundle.changed
- name: install nodejs packages
  command: /usr/local/bin/npm install
  args:
    chdir: /srv/TeruImages/bundle/programs/server
  when: bundle.changed
  notify:
  - restart TeruImages
